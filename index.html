<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>REI Marketing ROI ‚Äî MBPS</title>
  <meta name="theme-color" content="#0ea5e9" />
  <link rel="manifest" href="manifest.json" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />

  <!-- Inter font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['Inter','ui-sans-serif','system-ui'] },
          colors: {
            brand: {50:'#ecfeff',100:'#cffafe',200:'#a5f3fc',300:'#67e8f9',400:'#22d3ee',500:'#06b6d4',600:'#0891b2',700:'#0e7490',800:'#155e75',900:'#164e63'}
          },
          boxShadow: {
            glow: '0 0 0 2px rgba(6,182,212,.25), 0 12px 40px rgba(6,182,212,.20)',
            soft: '0 16px 40px rgba(0,0,0,.25)'
          }
        }
      }
    }
  </script>
  <style>
    :root { color-scheme: light dark; }
    .glass { border-radius: 18px; border: 1px solid rgba(255,255,255,.10);
      background: rgba(17,24,39,.68); -webkit-backdrop-filter: blur(12px); backdrop-filter: blur(12px);
      box-shadow: 0 10px 30px rgba(0,0,0,.25); }
    :root:not(.dark) .glass { background: rgba(255,255,255,.86); }
    .metric { border-radius: 14px; border: 1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,0)); }
    .input { width:100%; border-radius:12px; padding:12px 14px; border:1px solid rgba(148,163,184,.3);
      background: rgba(255,255,255,.85); }
    .dark .input { background: rgba(2,6,23,.4); color:#E5E7EB; border:1px solid rgba(148,163,184,.25); }
    .input:focus { outline:none; box-shadow:0 0 0 2px rgba(6,182,212,.35); }
    .label { font-size:12px; font-weight:600; letter-spacing:.02em; color:#6B7280; }
    .dark .label { color:#94A3B8; }
    .number { font-variant-numeric: tabular-nums; }
    @media print { header,.no-print { display:none !important; } body { background:#fff !important; } }
  </style>

  <script>
    // Theme boot (persist)
    (function(){
      const saved = localStorage.getItem('mbps_theme');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      if (saved === 'light') document.documentElement.classList.remove('dark');
      else if (saved === 'dark') document.documentElement.classList.add('dark');
      else if (prefersDark) document.documentElement.classList.add('dark');
    })();
  </script>
</head>

<body class="font-sans min-h-screen text-slate-800 dark:text-slate-100 bg-gradient-to-b from-slate-900 via-slate-950 to-slate-900 relative">
  <!-- BG accents -->
  <div class="pointer-events-none absolute inset-0 -z-10">
    <div class="absolute -top-24 -left-24 h-96 w-96 rounded-full blur-3xl opacity-30"
         style="background: radial-gradient(120px 120px at 50% 50%, rgba(6,182,212,.65), transparent 70%);"></div>
    <div class="absolute -bottom-24 -right-24 h-[28rem] w-[28rem] rounded-full blur-3xl opacity-25"
         style="background: radial-gradient(140px 140px at 50% 50%, rgba(14,116,144,.55), transparent 70%);"></div>
  </div>

  <!-- Header -->
  <header class="no-print">
    <div class="max-w-5xl mx-auto px-4 py-5 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-10 w-10 grid place-items-center rounded-2xl bg-brand-500/20 text-brand-300 text-xl shadow-glow">üßÆ</div>
        <div>
          <h1 class="text-xl font-extrabold tracking-tight">REI Marketing ROI ‚Äî MBPS</h1>
          <p class="text-xs text-slate-500 dark:text-slate-400">Plan-based modeling with combined totals (Funnel: Spend ‚Üí Leads ‚Üí Contracts)</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="themeBtn" class="px-3 py-2 rounded-xl border border-slate-300 dark:border-slate-700 bg-white/70 dark:bg-slate-900/40 hover:shadow-glow text-sm">Light/Dark</button>
        <button id="installBtn" class="px-3 py-2 rounded-xl border border-slate-300 dark:border-slate-700 bg-white/70 dark:bg-slate-900/40 hover:shadow-glow text-sm hidden">Install</button>
        <button id="csvBtn" class="px-3 py-2 rounded-xl border border-slate-300 dark:border-slate-700 bg-white/70 dark:bg-slate-900/40 hover:shadow-glow text-sm">Export CSV</button>
        <button id="resetBtn" class="px-3 py-2 rounded-xl border border-slate-300 dark:border-slate-700 bg-white/70 dark:bg-slate-900/40 hover:shadow-glow text-sm">Reset</button>
        <button id="printBtn" class="px-3 py-2 rounded-xl bg-brand-600 text-white hover:shadow-glow text-sm">Print / PDF</button>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-5xl mx-auto px-4 pb-20">

    <!-- KPIs -->
    <section class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
      <div class="metric p-4 glass"><div class="text-[11px] label">Total Marketing Budget</div><div id="kpiMkt" class="number text-2xl font-extrabold">$0</div></div>
      <div class="metric p-4 glass"><div class="text-[11px] label">VA Spend</div><div id="kpiVA" class="number text-2xl font-extrabold">$0</div></div>
      <div class="metric p-4 glass"><div class="text-[11px] label">Deals / Mo</div><div id="kpiDeals" class="number text-2xl font-extrabold">0.00</div></div>
      <div class="metric p-4 glass"><div class="text-[11px] label">ROI</div><div id="kpiROI" class="number text-2xl font-extrabold">0%</div></div>
    </section>

    <!-- Plan Card with LEFT-ALIGNED SELECTOR + PRESETS -->
    <section class="glass p-6 md:p-8">
      <div class="flex flex-wrap items-center justify-between gap-4 mb-5">
        <div class="flex items-center gap-3">
          <label class="label">Select Marketing Plan</label>
          <div class="relative">
            <select id="planSelector" class="pl-10 pr-8 py-2 rounded-xl border border-slate-300 dark:border-slate-700 bg-white/80 dark:bg-slate-900/40 hover:shadow-glow text-sm appearance-none">
              <option value="sms">üì± SMS</option>
              <option value="calls">‚òéÔ∏è Calls</option>
              <option value="mail">‚úâÔ∏è Mail</option>
              <option value="ppl">üíª PPC / PPL</option>
            </select>
            <span class="pointer-events-none absolute left-3 top-2.5">üîÄ</span>
            <span class="pointer-events-none absolute right-3 top-2.5">‚ñæ</span>
          </div>

          <div class="relative ml-4">
            <select id="presetSelector" class="pl-10 pr-8 py-2 rounded-xl border border-slate-300 dark:border-slate-700 bg-white/80 dark:bg-slate-900/40 hover:shadow-glow text-sm appearance-none">
              <option value="baseline">‚öñÔ∏è Baseline</option>
              <option value="aggressive">üî• Aggressive</option>
              <option value="conservative">üßä Conservative</option>
            </select>
            <span class="pointer-events-none absolute left-3 top-2.5">üéõÔ∏è</span>
            <span class="pointer-events-none absolute right-3 top-2.5">‚ñæ</span>
          </div>
        </div>

        <div class="flex items-center gap-2">
          <input id="planEnabled" type="checkbox" class="h-4 w-4" checked />
          <label for="planEnabled" class="text-sm text-slate-600 dark:text-slate-300">Include this plan in totals</label>
        </div>
      </div>

      <div id="planForm" class="grid md:grid-cols-3 gap-6">
        <!-- Column 1: Budget -->
        <div>
          <h2 class="text-sm font-semibold text-brand-300 mb-3">Plan Budget</h2>
          <div class="grid gap-4">
            <div>
              <label class="label">Budget for this Plan ($/mo)</label>
              <input id="pBudget" type="number" class="input" min="0" value="2500" />
            </div>

            <!-- Cost input switches label depending on plan type -->
            <div>
              <label id="costLabel" class="label">Cost per Touch</label>
              <input id="pCost" type="number" step="0.0001" class="input" min="0" value="0.012" />
            </div>
          </div>
        </div>

        <!-- Column 2: Funnel Rates -->
        <div>
          <h2 class="text-sm font-semibold text-brand-300 mb-3">Funnel (This Plan)</h2>
          <div class="grid gap-4">
            <div>
              <label id="leadRateLabel" class="label">Touch ‚Üí Lead %</label>
              <input id="pLeadRate" type="number" step="0.01" class="input" min="0" max="100" value="2" />
            </div>
            <div>
              <label id="dealRateLabel" class="label">Lead ‚Üí Contract %</label>
              <input id="pDealRate" type="number" step="0.01" class="input" min="0" max="100" value="2" />
            </div>
          </div>
        </div>

        <!-- Column 3: Output (per selected plan) -->
        <div>
          <h2 class="text-sm font-semibold text-brand-300 mb-3">This Plan ‚Äî Output</h2>
          <div class="grid gap-4">
            <div>
              <label class="label">Touches / Mo (est.)</label>
              <input id="pTouches" class="input" value="0" disabled />
            </div>
            <div>
              <label class="label">Leads / Mo (est.)</label>
              <input id="pLeads" class="input" value="0" disabled />
            </div>
            <div>
              <label class="label">Deals / Mo (est.)</label>
              <input id="pDeals" class="input" value="0.00" disabled />
            </div>
            <div>
              <label class="label">Revenue / Mo (this plan)</label>
              <input id="pRevenue" class="input" value="$0" disabled />
            </div>
          </div>
        </div>
      </div>

      <!-- VA + Global Settings -->
      <div class="mt-8 grid md:grid-cols-3 gap-6">
        <div>
          <h2 class="text-sm font-semibold text-brand-300 mb-3">VA Spend</h2>
          <div class="space-y-3">
            <div class="flex items-center gap-2">
              <input id="useVABudget" type="checkbox" class="h-4 w-4">
              <label for="useVABudget" class="text-sm text-slate-500 dark:text-slate-400">Enter VA budget directly</label>
            </div>
            <div id="vaByPeople" class="grid grid-cols-3 gap-4">
              <div><label class="label"># of VAs</label><input id="vaCount" type="number" class="input" value="1" min="0"></div>
              <div><label class="label">VA $/hr</label><input id="vaRate" type="number" class="input" value="6" min="0" step="0.01"></div>
              <div><label class="label">Hours/Week</label><input id="vaHours" type="number" class="input" value="20" min="0"></div>
            </div>
            <div id="vaByBudget" class="hidden">
              <label class="label">VA budget ($/mo)</label><input id="vaBudget" type="number" class="input" value="0" min="0">
            </div>
          </div>
        </div>

        <div>
          <h2 class="text-sm font-semibold text-brand-300 mb-3">Economics</h2>
          <div class="grid gap-4">
            <div>
              <label class="label">Average Deal Size ($)</label>
              <input id="dealSize" type="number" class="input" value="15000" min="0">
            </div>
            <div class="flex items-center gap-2">
              <input id="toggleOverhead" type="checkbox" class="h-4 w-4">
              <label for="toggleOverhead" class="text-sm text-slate-600 dark:text-slate-300">Treat VA as fixed overhead (exclude from CPA)</label>
            </div>
          </div>
        </div>

        <div>
          <h2 class="text-sm font-semibold text-brand-300 mb-3">Per-Deal Metrics</h2>
          <div class="grid grid-cols-2 gap-3 text-sm">
            <div class="p-3 rounded-xl border border-white/10 bg-white/60 dark:bg-white/5">
              <div class="text-slate-500 dark:text-slate-400">Cost per Deal (marketing only)</div>
              <div id="cpa" class="number font-semibold">$0</div>
            </div>
            <div class="p-3 rounded-xl border border-white/10 bg-white/60 dark:bg-white/5">
              <div class="text-slate-500 dark:text-slate-400">Profit per Deal</div>
              <div id="ppd" class="number font-semibold">$0</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Goal Seek -->
      <div class="mt-8 grid md:grid-cols-2 gap-6">
        <div class="p-5 rounded-2xl border border-white/10 bg-white/70 dark:bg-white/5">
          <h3 class="text-sm font-semibold text-brand-300 mb-3">Goal Seek ‚Äî Target Deals/Month</h3>
          <div class="flex gap-3 items-center">
            <input id="goalDeals" type="number" value="3" class="input w-32" />
            <button id="goalSolve" class="px-3 py-2 rounded-xl bg-brand-600 text-white hover:shadow-glow text-sm">Solve by adjusting this plan‚Äôs budget</button>
          </div>
          <div id="goalResult" class="text-sm text-slate-600 dark:text-slate-300 mt-2"></div>
        </div>

        <div class="p-5 rounded-2xl border border-white/10 bg-white/70 dark:bg-white/5">
          <h3 class="text-sm font-semibold text-brand-300 mb-3">Goal Seek ‚Äî Target Profit/Month ($)</h3>
          <div class="flex gap-3 items-center">
            <input id="goalProfit" type="number" value="30000" class="input w-40" />
            <button id="goalSolveProfit" class="px-3 py-2 rounded-xl bg-brand-600 text-white hover:shadow-glow text-sm">Solve by adjusting this plan‚Äôs budget</button>
          </div>
          <div id="goalResultProfit" class="text-sm text-slate-600 dark:text-slate-300 mt-2"></div>
        </div>
      </div>
    </section>

    <!-- Totals Table -->
    <section class="mt-6 glass p-6 md:p-8">
      <h2 class="text-sm font-semibold text-brand-300 mb-3">Combined Totals (Included Plans)</h2>
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead class="text-left text-slate-500 dark:text-slate-400 border-b border-white/10">
            <tr><th>Plan</th><th>Budget</th><th>Touches</th><th>Leads</th><th>Deals</th><th>Revenue</th><th>Cost</th><th>Profit</th></tr>
          </thead>
          <tbody id="tableBody" class="text-slate-800 dark:text-slate-200"></tbody>
          <tfoot class="border-t border-white/10 font-semibold">
            <tr><td>Totals</td><td id="tBudget"></td><td id="tTouches"></td><td id="tLeads"></td><td id="tDeals"></td><td id="tRevenue"></td><td id="tCost"></td><td id="tProfit"></td></tr>
          </tfoot>
        </table>
      </div>
    </section>

    <footer class="py-10 text-center text-xs text-slate-500 dark:text-slate-400">
      ¬© <span id="year"></span> MBPS ‚Äî Deal Sprint | DealDesk
    </footer>
  </main>

  <!-- App Logic -->
  <script>
    const el = id => document.getElementById(id);
    const fmt = (n, d=0) => isFinite(n) ? n.toLocaleString(undefined,{minimumFractionDigits:d,maximumFractionDigits:d}) : '-';
    const money = (n, d=0) => `$${fmt(n, d)}`;

    // Theme toggle
    el('themeBtn').addEventListener('click', ()=>{
      document.documentElement.classList.toggle('dark');
      const mode = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
      localStorage.setItem('mbps_theme', mode);
    });

    // ---- Plans (funnel model) ----
    // type: 'touch' channels use cost per touch & lead/deal % (sms, calls, mail)
    // type: 'lead' channels use cost per lead & lead->deal % (ppl)
    const plans = {
      sms:  { type:'touch', name:'SMS',   icon:'üì±', enabled:true,  budget:2500, cost:0.012, leadRate:2,  dealRate:2 },
      calls:{ type:'touch', name:'Calls', icon:'‚òéÔ∏è', enabled:false, budget:0,    cost:0.06,  leadRate:10, dealRate:17 },
      mail: { type:'touch', name:'Mail',  icon:'‚úâÔ∏è', enabled:false, budget:0,    cost:0.85,  leadRate:1,  dealRate:4 },
      ppl:  { type:'lead',  name:'PPC/PPL',icon:'üíª',enabled:false, budget:5000, cost:100,   leadRate:100, dealRate:3 }
      // For 'lead' type, leadRate is a fixed 100% (budget/cost = leads). We keep the field for uniformity.
    };
    let selectedPlan = 'sms';

    // Presets adjust ALL plans at once
    const presets = {
      baseline: () => {
        plans.sms.cost=0.012; plans.sms.leadRate=2;  plans.sms.dealRate=2;
        plans.calls.cost=0.06; plans.calls.leadRate=10; plans.calls.dealRate=17;
        plans.mail.cost=0.85;  plans.mail.leadRate=1; plans.mail.dealRate=4;
        plans.ppl.cost=100;    plans.ppl.dealRate=3;
      },
      aggressive: () => {
        plans.sms.cost=0.012;  plans.sms.leadRate=2.5; plans.sms.dealRate=2.5;
        plans.calls.cost=0.055;plans.calls.leadRate=20; plans.calls.dealRate=20;
        plans.mail.cost=0.80;  plans.mail.leadRate=2;  plans.mail.dealRate=5;
        plans.ppl.cost=80;     plans.ppl.dealRate=4;
      },
      conservative: () => {
        plans.sms.cost=0.012;  plans.sms.leadRate=1.5; plans.sms.dealRate=1.5;
        plans.calls.cost=0.065;plans.calls.leadRate=5;  plans.calls.dealRate=15;
        plans.mail.cost=0.90;  plans.mail.leadRate=0.5;plans.mail.dealRate=3;
        plans.ppl.cost=120;    plans.ppl.dealRate=2;
      }
    };

    // --- VA & global economics ---
    function getVASpend(){
      if (el('useVABudget').checked) return +el('vaBudget').value || 0;
      const count = +el('vaCount').value || 0, rate = +el('vaRate').value || 0, hrs = +el('vaHours').value || 0;
      return count * rate * hrs * 4.33;
    }
    let treatVAAsOverhead = false;

    // ---- Per-plan math (funnel) ----
    function calcPlan(p, dealSize){
      if (!p.enabled) return { touches:0, leads:0, deals:0, revenue:0, cost:0, profit:0 };

      if (p.type === 'touch'){
        const touches = p.cost>0 ? (p.budget / p.cost) : 0;
        const leads = touches * (p.leadRate/100);
        const deals = leads * (p.dealRate/100);
        const revenue = deals * dealSize;
        const cost = p.budget;
        const profit = revenue - cost;
        return { touches, leads, deals, revenue, cost, profit };
      } else { // 'lead' type (PPC/PPL)
        const leads = p.cost>0 ? (p.budget / p.cost) : 0;
        const deals = leads * (p.dealRate/100);
        const revenue = deals * dealSize;
        const cost = p.budget;
        const profit = revenue - cost;
        return { touches:0, leads, deals, revenue, cost, profit };
      }
    }

    function combinedCalc(){
      const dealSize = +el('dealSize').value || 0;
      const vaSpend = getVASpend();

      const rows = Object.entries(plans).map(([key,p])=>{
        const r = calcPlan(p, dealSize);
        return { key, name:p.name, icon:p.icon, ...r };
      });

      const mktCost = rows.reduce((a,r)=>a+r.cost,0);
      const totalCost = mktCost + vaSpend;
      const revenue = rows.reduce((a,r)=>a+r.revenue,0);
      const profit = revenue - totalCost;
      const roi = totalCost>0 ? (profit/totalCost) : 0;

      const totals = {
        budget: mktCost + vaSpend,
        touches: rows.reduce((a,r)=>a+r.touches,0),
        leads: rows.reduce((a,r)=>a+r.leads,0),
        deals: rows.reduce((a,r)=>a+r.deals,0),
        revenue, mktCost, vaSpend, totalCost, profit, roi, dealSize
      };
      return { rows, totals };
    }

    // --- Goal Seek: adjust selected plan's budget to meet global target ---
    function setSelectedBudget(val){ plans[selectedPlan].budget = Math.max(0, Math.round(val)); }
    function budgetForDeals(targetDeals, maxIter=32){
      let lo=0, hi=100000;
      for (let i=0;i<maxIter;i++){
        const mid=(lo+hi)/2; setSelectedBudget(mid);
        const r = combinedCalc().totals; (r.deals >= targetDeals) ? hi=mid : lo=mid;
      }
      setSelectedBudget(hi); syncPlanFields(); render();
      return hi;
    }
    function budgetForProfit(targetProfit, maxIter=32){
      let lo=0, hi=100000;
      for (let i=0;i<maxIter;i++){
        const mid=(lo+hi)/2; setSelectedBudget(mid);
        const r = combinedCalc().totals; (r.profit >= targetProfit) ? hi=mid : lo=mid;
      }
      setSelectedBudget(hi); syncPlanFields(); render();
      return hi;
    }

    // --- UI sync for selected plan fields ---
    function syncCostLabels(){
      const p = plans[selectedPlan];
      if (p.type === 'touch'){
        el('costLabel').textContent = 'Cost per Touch';
        el('leadRateLabel').textContent = 'Touch ‚Üí Lead %';
        el('dealRateLabel').textContent = 'Lead ‚Üí Contract %';
      } else {
        el('costLabel').textContent = 'Cost per Lead';
        el('leadRateLabel').textContent = 'Lead Rate (fixed)';
        el('dealRateLabel').textContent = 'Lead ‚Üí Contract %';
      }
    }

    function syncPlanFields(){
      const p = plans[selectedPlan];
      el('planEnabled').checked = !!p.enabled;
      el('pBudget').value = p.budget;
      el('pCost').value = p.cost;
      el('pLeadRate').value = p.leadRate;
      el('pDealRate').value = p.dealRate;
      syncCostLabels();

      // Quick outputs for current plan
      const sz = +el('dealSize').value || 0;
      const r = calcPlan(p, sz);
      el('pTouches').value = fmt(r.touches,0);
      el('pLeads').value = fmt(r.leads,0);
      el('pDeals').value = fmt(r.deals,2);
      el('pRevenue').value = money(r.revenue,0);
    }

    // --- Render totals + table + KPIs ---
    function render(){
      const { rows, totals } = combinedCalc();

      // KPIs
      el('kpiMkt').textContent = money(totals.mktCost);
      el('kpiVA').textContent = money(totals.vaSpend);
      el('kpiDeals').textContent = fmt(totals.deals,2);
      el('kpiROI').textContent = fmt(totals.roi*100,0)+'%';

      // Table
      const body = el('tableBody'); body.innerHTML='';
      rows.forEach(row=>{
        const p = plans[row.key];
        const disabled = !p.enabled;
        const tr = document.createElement('tr');
        tr.className = 'border-b border-white/10 last:border-0';
        tr.innerHTML = `
          <td class="py-2 ${disabled?'text-slate-500':''}">${p.icon} ${p.name}${disabled?' (off)':''}</td>
          <td class="number">${money(row.cost)}</td>
          <td class="number">${fmt(row.touches,0)}</td>
          <td class="number">${fmt(row.leads,0)}</td>
          <td class="number">${fmt(row.deals,2)}</td>
          <td class="number">${money(row.revenue)}</td>
          <td class="number">${money(row.cost)}</td>
          <td class="number">${money(row.profit)}</td>`;
        body.appendChild(tr);
      });

      // Totals in table
      el('tBudget').textContent = money(totals.budget);
      el('tTouches').textContent = fmt(totals.touches,0);
      el('tLeads').textContent = fmt(totals.leads,0);
      el('tDeals').textContent = fmt(totals.deals,2);
      el('tRevenue').textContent = money(totals.revenue);
      el('tCost').textContent = money(totals.totalCost);
      el('tProfit').textContent = money(totals.profit);

      // CPA (marketing-only) & Profit/Deal
      const costForCPA = treatVAAsOverhead ? totals.mktCost : totals.totalCost;
      const cpa = totals.deals>0 ? (costForCPA / totals.deals) : 0;
      const ppd = totals.deals>0 ? (totals.profit / totals.deals) : 0;
      el('cpa').textContent = money(cpa,0);
      el('ppd').textContent = money(ppd,0);

      // Keep current plan outputs fresh
      syncPlanFields();

      // Snapshot for CSV
      window.__roiSnapshot = {
        timestamp: new Date().toISOString(),
        plans: JSON.parse(JSON.stringify(plans)),
        totals: {
          budget: totals.budget, touches: totals.touches, leads: totals.leads, deals: totals.deals,
          revenue: totals.revenue, cost: totals.totalCost, profit: totals.profit, roi: totals.roi,
          va_spend: totals.vaSpend
        },
        deal_size: totals.dealSize,
        treatVAAsOverhead
      };
    }

    // CSV
    function toCSV(){
      const s = window.__roiSnapshot; if(!s) return '';
      const L = [];
      L.push('Section,Metric,Value');
      L.push(`Inputs,Deal Size,${s.deal_size}`);
      L.push(`Inputs,VA Spend,${s.totals.va_spend}`);
      L.push(`Inputs,Treat VA As Overhead,${s.treatVAAsOverhead}`); L.push('');
      L.push('Plan,Type,Budget,CostUnit,Lead%,Deal%,Touches,Leads,Deals,Revenue,Cost,Profit,Included');
      Object.entries(s.plans).forEach(([k,p])=>{
        const isTouch = p.type==='touch';
        const dealSize = s.deal_size;
        let touches=0, leads=0, deals=0, revenue=0, cost=p.budget, profit=0;
        if (isTouch){
          touches = p.cost>0 ? p.budget/p.cost : 0;
          leads = touches * (p.leadRate/100);
          deals = leads * (p.dealRate/100);
        } else {
          leads = p.cost>0 ? p.budget/p.cost : 0;
          deals = leads * (p.dealRate/100);
        }
        revenue = deals * dealSize; profit = revenue - cost;
        L.push([p.name,p.type,p.budget,p.cost,p.leadRate,p.dealRate,touches,leads,deals,revenue,cost,profit,p.enabled].join(','));
      });
      L.push('');
      L.push('Totals,Budget,Touches,Leads,Deals,Revenue,Cost,Profit,ROI');
      L.push(['Totals', s.totals.budget, s.totals.touches, s.totals.leads, s.totals.deals, s.totals.revenue, s.totals.cost, s.totals.profit, s.totals.roi].join(','));
      return L.join('\n');
    }
    function downloadCSV(){
      const blob = new Blob([toCSV()], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a=document.createElement('a'), stamp=new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
      a.href=url; a.download=`rei-roi-funnel-${stamp}.csv`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    // Wire plan selector + fields
    function applyPlanFieldChanges(){
      const p = plans[selectedPlan];
      p.enabled = el('planEnabled').checked;
      p.budget  = +el('pBudget').value || 0;
      p.cost    = +el('pCost').value   || 0;
      p.leadRate= +el('pLeadRate').value || 0;
      p.dealRate= +el('pDealRate').value || 0;
      render();
    }
    ['planEnabled','pBudget','pCost','pLeadRate','pDealRate'].forEach(id => el(id).addEventListener('input', applyPlanFieldChanges));

    el('planSelector').addEventListener('change', (e)=>{
      selectedPlan = e.target.value;
      // Auto-enable newly selected plan
      plans[selectedPlan].enabled = true;
      el('planEnabled').checked = true;
      syncPlanFields();
      render();
      // Adjust labels for cost/rates per type
    });

    el('presetSelector').addEventListener('change', (e)=>{
      const v = e.target.value || 'baseline';
      (presets[v] || presets.baseline)();
      syncPlanFields(); render();
    });

    // Wire VA + economics
    el('useVABudget').addEventListener('change', ()=>{
      const useB = el('useVABudget').checked;
      el('vaByBudget').classList.toggle('hidden', !useB);
      el('vaByPeople').classList.toggle('hidden', useB);
      render();
    });
    ['vaCount','vaRate','vaHours','vaBudget','dealSize'].forEach(id=>el(id).addEventListener('input', render));
    el('toggleOverhead').addEventListener('change', e=>{ treatVAAsOverhead = e.target.checked; render(); });

    // Goal seek
    el('goalSolve').addEventListener('click', ()=>{
      const t=+el('goalDeals').value||0; if(t<=0) return;
      const b=budgetForDeals(t);
      const name=plans[selectedPlan].name;
      el('goalResult').textContent = `Adjusted ${name} budget to ‚âà ${money(b)}/mo`;
    });
    el('goalSolveProfit').addEventListener('click', ()=>{
      const t=+el('goalProfit').value||0; if(t<=0) return;
      const b=budgetForProfit(t);
      const name=plans[selectedPlan].name;
      el('goalResultProfit').textContent = `Adjusted ${name} budget to ‚âà ${money(b)}/mo`;
    });

    // Header buttons
    el('csvBtn').addEventListener('click', downloadCSV);
    el('printBtn').addEventListener('click', ()=>window.print());
    el('resetBtn').addEventListener('click', ()=>{
      // Defaults: SMS on, others off, baseline preset
      plans.sms  = { type:'touch', name:'SMS',   icon:'üì±', enabled:true,  budget:2500, cost:0.012, leadRate:2,  dealRate:2 };
      plans.calls= { type:'touch', name:'Calls', icon:'‚òéÔ∏è', enabled:false, budget:0,    cost:0.06,  leadRate:10, dealRate:17 };
      plans.mail = { type:'touch', name:'Mail',  icon:'‚úâÔ∏è', enabled:false, budget:0,    cost:0.85,  leadRate:1,  dealRate:4 };
      plans.ppl  = { type:'lead',  name:'PPC/PPL',icon:'üíª',enabled:false, budget:5000, cost:100,   leadRate:100, dealRate:3 };
      selectedPlan = 'sms';

      el('planSelector').value = 'sms';
      el('presetSelector').value = 'baseline';
      el('planEnabled').checked = true;

      el('pBudget').value = 2500; el('pCost').value = 0.012; el('pLeadRate').value = 2; el('pDealRate').value = 2;

      el('useVABudget').checked = false;
      el('vaCount').value = 1; el('vaRate').value = 6; el('vaHours').value = 20; el('vaBudget').value = 0;
      el('dealSize').value = 15000;
      el('toggleOverhead').checked = false; treatVAAsOverhead = false;

      el('goalDeals').value = 3; el('goalProfit').value = 30000;
      el('goalResult').textContent = ''; el('goalResultProfit').textContent = '';
      syncPlanFields(); render();
    });

    // PWA install + SW
    let deferredPrompt=null; const installBtn=el('installBtn');
    document.addEventListener('DOMContentLoaded', ()=>{
      el('year').textContent = new Date().getFullYear();
      presets.baseline();
      syncPlanFields(); render();
      if ('serviceWorker' in navigator) navigator.serviceWorker.register('service-worker.js').catch(()=>{});
      window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt=e; installBtn.classList.remove('hidden'); });
      installBtn.addEventListener('click', async ()=>{
        if(!deferredPrompt) return; deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt=null; installBtn.classList.add('hidden');
      });
      window.addEventListener('appinstalled', ()=>{ installBtn.classList.add('hidden'); deferredPrompt=null; });
    });
  </script>
</body>
</html>
